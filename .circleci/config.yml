version: 2.1

jobs:
  gerar_e_publicar_documentacao_poc:
    docker:
      - image: cimg/ruby:3.2.0 # Imagem principal com Ruby
        environment:
          RAILS_ENV: test
          DATABASE_URL: "postgresql://postgres:password@localhost/app_test"
      - image: cimg/postgres:13.9
        environment:
          POSTGRES_USER: postgres
          POSTGRES_DB: app_test
          POSTGRES_PASSWORD: password

    steps:
      - checkout

      # -- Etapa de Prepara√ß√£o --
      - run:
          name: "Instala Node.js 18"
          command: |
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
            node -v
            npm -v

      - run:
          name: "Instala Depend√™ncias Ruby"
          command: bundle install --jobs=4 --retry=3 --path vendor/bundle

      - run:
          name: "Prepara Banco de Dados de Teste"
          command: |
            dockerize -wait tcp://localhost:5432 -timeout 1m
            bundle exec rails db:create
            bundle exec rails db:migrate

      # -- Etapa 1: Testar --
      - run:
          name: "Roda Testes (RSpec)"
          command: bundle exec rspec

      # -- Etapa 2: Gerar --
      - run:
          name: "Gera Especifica√ß√£o OpenAPI com Rswag"
          command: bundle exec rails rswag:specs:swaggerize

      # -- Etapa 3: Publicar --
      - run:
          name: "Instala a CLI do ReadMe"
          command: |
            sudo npm install -g rdme@10
            rdme --version

      - run:
          name: "Verifica vari√°veis obrigat√≥rias e arquivo gerado"
          command: |
            if [ -z "$RDME_API_KEY" ]; then
              echo "‚ùå Vari√°vel RDME_API_KEY n√£o definida!"; exit 1;
            fi

            if [ ! -f swagger/v1/swagger.yaml ]; then
              echo "‚ùå Arquivo swagger/v1/swagger.yaml n√£o encontrado!"; exit 1;
            fi

      - run:
          name: "Publica a Documenta√ß√£o da API no ReadMe"
          command: |
            SLUG_PREFIX="minha-api-poc"
            COMMIT_HASH=$(echo $CIRCLE_SHA1 | cut -c 1-7)
            GENERATED_SLUG="${SLUG_PREFIX}-${COMMIT_HASH}"

            echo "üìò Publicando documenta√ß√£o no ReadMe com slug: $GENERATED_SLUG"
            cat swagger/v1/swagger.yaml
            echo "Usando chave de API: $RDME_API_KEY"
            rdme openapi upload swagger/v1/swagger.yaml --key="$RDME_API_KEY" --slug="$GENERATED_SLUG"

workflows:
  poc_workflow:
    jobs:
      - gerar_e_publicar_documentacao_poc:
          filters:
            branches:
              only:
                - main
